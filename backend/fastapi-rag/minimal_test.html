<!DOCTYPE html>
<html>
<head>
    <title>Minimal Chat Test</title>
</head>
<body>
    <h1>Minimal Chat Test</h1>
    <input type="text" id="input" placeholder="Type a message">
    <button onclick="send()">Send</button>
    <div id="output"></div>

    <script>
        function log(msg) {
            document.getElementById('output').innerHTML += '<p>' + msg + '</p>';
        }

        async function send() {
            const input = document.getElementById('input');
            const message = input.value;
            if (!message) return;

            log('Sending: ' + message);
            input.value = '';

            try {
                log('Making request...');
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: message })
                });

                log('Response status: ' + response.status);
                
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }

                log('Reading stream...');
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    log('Chunk: ' + chunk.substring(0, 100));

                    // Parse the chunk
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.token) {
                                    fullResponse += data.token;
                                    log('Token: ' + data.token);
                                } else if (data.text) {
                                    log('Final: ' + data.text);
                                }
                            } catch (e) {
                                // Ignore parse errors
                            }
                        }
                    }
                }

                log('Complete response: ' + fullResponse);

            } catch (error) {
                log('Error: ' + error.message);
            }
        }

        // Enter key support
        document.getElementById('input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') send();
        });

        log('Ready! Type a message and click Send.');
    </script>
</body>
</html>
